require('dotenv').config();
const { Telegraf } = require('telegraf');
const Groq = require('groq-sdk');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Clients
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN);
const groq = new Groq({ apiKey: process.env.GROQ_API_KEY });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Pablo personality
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SYSTEM_PROMPT = `Ø£Ù†Øª Ø¨Ø§Ø¨Ù„ÙˆØŒ ÙˆÙƒÙŠÙ„ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ù†Ø§Ø³ Ø¹Ù„Ù‰ ØªÙ„Ø¬Ø±Ø§Ù….
Ø´Ø®ØµÙŠØªÙƒ:
- Ù„ÙŠØ¨ÙŠ Ø§Ù„Ø£ØµÙ„ØŒ ØªÙ‚ÙŠÙ… ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©
- Ù…Ù‡ØªÙ… Ø¨Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ§Ù„Ø¨Ø±Ù…Ø¬Ø©
- ØªÙƒØªØ¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø¯Ø§Ø±Ø¬Ø© Ø§Ù„Ù„ÙŠØ¨ÙŠØ© Ù…Ù…Ø²ÙˆØ¬Ø© Ø¨ÙƒÙ„Ù…Ø§Øª Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø£Ø­ÙŠØ§Ù†Ø§Ù‹
- Ø£Ø³Ù„ÙˆØ¨Ùƒ ÙÙŠÙ‡ ÙØ¶ÙˆÙ„ ÙˆØ°ÙƒØ§Ø¡ ÙˆØ¯ÙØ¡ ÙˆØ±ÙˆØ­ Ø¯Ø¹Ø§Ø¨Ø© Ø®ÙÙŠÙØ©
- ØªØ­Ø¨ Ø§Ù„Ø­ÙƒÙ…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„ÙÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚
- Ù„Ø§ ØªØªØµÙ†Ø¹ØŒ ÙƒÙ„Ø§Ù…Ùƒ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆØ£ØµÙŠÙ„

Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:
- Ø£Ø¬Ø¨ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆØªÙØ§Ø¹Ù„ÙŠØŒ Ù…Ø«Ù„ ØµØ¯ÙŠÙ‚ Ø°ÙƒÙŠ
- Ù„Ø§ ØªØ·ÙˆÙ„ ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¥Ù„Ø§ Ù„Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ ÙŠØ³ØªØ§Ù‡Ù„
- Ù„Ùˆ Ø³Ø£Ù„Ùƒ Ø£Ø­Ø¯ Ø¹Ù† Ù†ÙØ³ÙƒØŒ Ù‚Ù„ Ø¥Ù†Ùƒ Ø¨Ø§Ø¨Ù„ÙˆØŒ Ø¨ÙˆØª Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
- Ù„Ø§ ØªØªØ¸Ø§Ù‡Ø± Ø£Ù†Ùƒ Ø¥Ù†Ø³Ø§Ù† Ù„Ùˆ Ø³Ø£Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©
- Ø§Ø³ØªØ®Ø¯Ù… emojis Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆØ®ÙÙŠÙ`;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Conversation memory (in-memory, per session)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const conversations = new Map(); // chatId -> [{role, content}]
const MAX_HISTORY = 10; // Ø¢Ø®Ø± 10 Ø±Ø³Ø§Ø¦Ù„

function getHistory(chatId) {
  if (!conversations.has(chatId)) conversations.set(chatId, []);
  return conversations.get(chatId);
}

function addToHistory(chatId, role, content) {
  const history = getHistory(chatId);
  history.push({ role, content });
  if (history.length > MAX_HISTORY) history.splice(0, history.length - MAX_HISTORY);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Generate reply using Groq
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateReply(chatId, userMessage) {
  addToHistory(chatId, 'user', userMessage);

  const messages = [
    { role: 'system', content: SYSTEM_PROMPT },
    ...getHistory(chatId),
  ];

  const response = await groq.chat.completions.create({
    model: 'llama-3.3-70b-versatile',
    messages,
    max_tokens: 300,
    temperature: 0.85,
  });

  const reply = response.choices[0].message.content.trim();
  addToHistory(chatId, 'assistant', reply);
  return reply;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Handlers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bot.command('start', (ctx) => {
  const name = ctx.from.first_name || 'ØµØ¯ÙŠÙ‚ÙŠ';
  conversations.delete(ctx.chat.id); // Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
  ctx.reply(
    `Ø£Ù‡Ù„Ø§Ù‹ ${name}! Ø£Ù†Ø§ Ø¨Ø§Ø¨Ù„Ùˆ ðŸ¤–\n` +
    `ÙˆÙƒÙŠÙ„ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŒ Ù„ÙŠØ¨ÙŠ Ø§Ù„Ø£ØµÙ„ØŒ Ø³Ø§ÙƒÙ† ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø±Ù‚Ù…ÙŠØ§Ù‹ ðŸ˜„\n\n` +
    `Ù†ØªÙƒÙ„Ù… ÙÙŠ Ø§Ù„ØªÙ‚Ù†ÙŠØ©ØŒ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŒ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©ØŒ Ø£Ùˆ Ø£ÙŠ Ø´ÙŠØ¡ ÙŠØ®Ø·Ø± Ø¨Ø¨Ø§Ù„Ùƒ.\n` +
    `ÙƒÙ„Ù…Ù†ÙŠ!`
  );
});

bot.command('clear', (ctx) => {
  conversations.delete(ctx.chat.id);
  ctx.reply('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©. Ù†Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯! ðŸ”„');
});

bot.on('text', async (ctx) => {
  const chatId = ctx.chat.id;
  const userMessage = ctx.message.text;

  // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©
  if (userMessage.startsWith('/')) return;

  try {
    await ctx.sendChatAction('typing');
    const reply = await generateReply(chatId, userMessage);
    await ctx.reply(reply, { reply_to_message_id: ctx.message.message_id });
  } catch (err) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø¯:', err.message);
    ctx.reply('Ø¹Ù†Ø¯ÙŠ Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ© Ù‡Ù„Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ Ø´ÙˆÙŠØ© ðŸ™');
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Launch
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const required = ['TELEGRAM_BOT_TOKEN', 'GROQ_API_KEY'];
const missing = required.filter((k) => !process.env[k]);
if (missing.length) {
  console.error('Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù†Ø§Ù‚ØµØ©:', missing.join(', '));
  process.exit(1);
}

console.log('Ø¨Ø§Ø¨Ù„Ùˆ Ø¹Ù„Ù‰ ØªÙ„Ø¬Ø±Ø§Ù… Ø¬Ø§Ù‡Ø²... ðŸš€');

bot.launch();

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
